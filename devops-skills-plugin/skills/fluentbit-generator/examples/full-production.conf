# Fluent Bit Configuration: Full Production Setup
# This is a complete, production-ready configuration with all best practices:
# - Proper buffer limits and retry logic
# - Security (TLS, no hardcoded credentials)
# - Performance optimization (compression, batching)
# - Reliability (filesystem buffering, health checks)
# - Observability (metrics, health endpoints)

[SERVICE]
    # Flush logs every 1 second
    Flush         1

    # Log level for production
    Log_Level     info

    # Run in foreground (for containers)
    Daemon        Off

    # HTTP server for health checks and metrics
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

    # Enable storage metrics for monitoring
    storage.metrics on

    # Parser configuration
    Parsers_File  parsers.conf

    # Grace period for shutdown (seconds)
    Grace         30

    # Enable hot reload
    Hot_Reload    On

# ===== INPUTS =====

[INPUT]
    Name              tail
    Tag               kube.*
    Path              /var/log/containers/*.log
    # Prevent log loops by excluding Fluent Bit's own logs
    Exclude_Path      /var/log/containers/*fluent-bit*.log,/var/log/containers/*fluentbit*.log
    Parser            docker
    # Position database for crash recovery
    DB                /var/log/flb_kube.db
    # Memory buffer limit per input (prevents OOM)
    Mem_Buf_Limit     50MB
    # Skip lines longer than 32KB (prevents hang)
    Skip_Long_Lines   On
    # Refresh file list every 10 seconds
    Refresh_Interval  10
    # Don't read from beginning (only new logs)
    Read_from_Head    Off
    # Rotate wait time
    Rotate_Wait       30
    # Skip empty lines
    Skip_Empty_Lines  On

# ===== FILTERS =====

# Kubernetes metadata enrichment
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    # Merge parsed JSON logs
    Merge_Log           On
    # Remove original log field after merge
    Keep_Log            Off
    # Honor pod annotations for parser
    K8S-Logging.Parser  On
    # Honor pod annotations for exclude
    K8S-Logging.Exclude On
    # Include pod labels
    Labels              On
    # Exclude annotations to reduce size
    Annotations         Off
    # Use TLS
    tls.verify          On
    # Cache settings
    Use_Kubelet         Off
    Buffer_Size         0

# Add cluster and environment identifiers
[FILTER]
    Name          modify
    Match         *
    Add           cluster_name production-eks-cluster
    Add           environment production
    Add           region us-east-1
    Add           version 1.0.0

# Lift nested Kubernetes fields to top level with prefix
[FILTER]
    Name          nest
    Match         *
    Operation     lift
    Nested_under  kubernetes
    Add_prefix    k8s_

# Filter out noisy logs (health checks, metrics endpoints)
[FILTER]
    Name          grep
    Match         *
    Exclude       log /health
    Exclude       log /metrics
    Exclude       log /readyz
    Exclude       log /livez

# Rate limiting: max 1000 logs per 5 second window
[FILTER]
    Name          throttle
    Match         *
    Rate          1000
    Window        5
    Interval      1m
    Print_Status  true

# ===== OUTPUTS =====

# Primary: Elasticsearch for real-time search and analysis
[OUTPUT]
    Name              es
    Match             *
    Host              elasticsearch.logging.svc.cluster.local
    Port              9200
    # Use Logstash format for time-based indices
    Logstash_Format   On
    Logstash_Prefix   k8s-prod
    # Daily indices
    Logstash_DateFormat %Y.%m.%d
    # Include tag in index
    Include_Tag_Key   On
    Tag_Key           @tag
    # Time key for @timestamp field
    Time_Key          @timestamp
    # Generate unique document IDs
    Generate_ID       On
    # Replace dots in field names with underscores
    Replace_Dots      On
    # Retry configuration
    Retry_Limit       3
    # Filesystem buffering for reliability
    storage.type      filesystem
    storage.path      /var/log/fluent-bit-buffer/
    storage.total_limit_size 5G
    # TLS configuration
    tls               On
    tls.verify        Off
    # Authentication via environment variables
    HTTP_User         ${ES_USER}
    HTTP_Passwd       ${ES_PASSWORD}
    # Buffer configuration
    Buffer_Size       False
    Type              _doc
    # Trace errors
    Trace_Error       On
    Trace_Output      On

# Secondary: S3 for long-term archival and compliance
[OUTPUT]
    Name              s3
    Match             *
    bucket            prod-k8s-logs-archive
    region            us-east-1
    # Upload when file reaches 100MB
    total_file_size   100M
    # Or after 10 minutes
    upload_timeout    10m
    # Use multipart upload (recommended)
    use_put_object    Off
    # Compression (reduces costs)
    compression       gzip
    # S3 key format with time-based partitioning
    s3_key_format     /logs/k8s/%Y/%m/%d/$TAG[0]/%H-%M-%S-$UUID.gz
    # Retry configuration
    Retry_Limit       3
    # Filesystem buffering
    storage.type      filesystem
    storage.path      /var/log/fluent-bit-buffer-s3/
    storage.total_limit_size 2G
    # IAM role authentication (no hardcoded credentials)
    # AWS credentials loaded from environment or IAM role
    # Store class for cost optimization
    store_dir         /tmp/fluent-bit/s3
    # Content type
    content_type      application/gzip

# Tertiary: CloudWatch for AWS-native monitoring
[OUTPUT]
    Name              cloudwatch_logs
    Match             kube.*
    region            us-east-1
    log_group_name    /aws/kubernetes/production-cluster
    log_stream_prefix fluent-bit-
    auto_create_group On
    # Retry configuration
    Retry_Limit       3
    # Use STS for authentication (IAM role)
    # Log key for message field
    log_key           log