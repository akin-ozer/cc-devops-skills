# Fluent Bit Configuration: Multi-Destination
# This configuration sends logs to multiple destinations: Elasticsearch for search,
# S3 for archival, and stdout for debugging.

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        Off
    HTTP_Server   On
    HTTP_Port     2020
    Parsers_File  parsers.conf

[INPUT]
    Name              tail
    Tag               app.logs
    Path              /var/log/app/*.log
    Parser            json
    DB                /var/log/flb_app.db
    Mem_Buf_Limit     100MB
    Skip_Long_Lines   On

[FILTER]
    Name          modify
    Match         *
    Add           environment production
    Add           region us-east-1

[FILTER]
    Name          parser
    Match         *
    Key_Name      message
    Parser        json
    Reserve_Data  On

# Primary destination: Elasticsearch for real-time search
[OUTPUT]
    Name              es
    Match             *
    Host              elasticsearch.logging.svc
    Port              9200
    Index             app-logs
    Retry_Limit       3
    storage.total_limit_size 5M

# Secondary destination: S3 for long-term archival
[OUTPUT]
    Name              s3
    Match             *
    bucket            logs-archive-prod
    region            us-east-1
    total_file_size   100M
    compression       gzip
    s3_key_format     /logs/app/%Y/%m/%d/%H-%M-%S-$UUID.gz
    Retry_Limit       3

# Debug destination: stdout
[OUTPUT]
    Name          stdout
    Match         *
    Format        json_lines