# Fluent Bit Configuration: Stream Processor
# This configuration demonstrates using the Stream Processor for SQL-like
# transformations, aggregations, and real-time analytics on log data.
# Stream tasks can create derived streams for alerts, metrics, and analytics.

[SERVICE]
    # Flush interval in seconds
    Flush        1

    # Log level: off, error, warn, info, debug, trace
    Log_Level    info

    # Daemon mode (Off for containers)
    Daemon       Off

    # HTTP server for health checks and metrics
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # Enable storage metrics
    storage.metrics on

    # Parser configuration file
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Tag               app.*
    Path              /var/log/app/*.log
    Parser            json
    DB                /var/log/flb_app.db
    Mem_Buf_Limit     100MB
    Skip_Long_Lines   On

# Stream Processor for advanced SQL-like transformations
[STREAM_TASK]
    Name    error_aggregation
    Exec    CREATE STREAM errors AS \
            SELECT \
                level, \
                COUNT(*) as error_count, \
                TUMBLE_START() as window_start \
            FROM TAG:'app.*' \
            WHERE level = 'error' \
            GROUP BY level, TUMBLE(time, INTERVAL '1' MINUTE);

[STREAM_TASK]
    Name    high_latency_detection
    Exec    CREATE STREAM high_latency AS \
            SELECT \
                service, \
                endpoint, \
                response_time_ms \
            FROM TAG:'app.*' \
            WHERE response_time_ms > 1000;

[FILTER]
    Name          modify
    Match         *
    Add           processed_by stream_processor

[OUTPUT]
    Name              es
    Match             app.*
    Host              elasticsearch
    Port              9200
    Index             app-logs
    Retry_Limit       3

[OUTPUT]
    Name              es
    Match             errors
    Host              elasticsearch
    Port              9200
    Index             error-metrics
    Retry_Limit       3

[OUTPUT]
    Name              es
    Match             high_latency
    Host              elasticsearch
    Port              9200
    Index             performance-alerts
    Retry_Limit       3
