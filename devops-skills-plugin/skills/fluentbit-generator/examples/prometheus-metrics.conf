# Fluent Bit Configuration: Prometheus Metrics Collection
# This configuration collects metrics from node_exporter and Fluent Bit's own HTTP server,
# and forwards them to Prometheus using the remote_write API.

[SERVICE]
    # Flush interval in seconds
    Flush        15

    # Log level: off, error, warn, info, debug, trace
    Log_Level    info

    # Daemon mode (Off for containers)
    Daemon       Off

    # HTTP server for health checks and metrics
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # Enable storage metrics
    storage.metrics on

[INPUT]
    Name              node_exporter_metrics
    Tag               node_metrics
    Scrape_interval   15

[INPUT]
    Name              prometheus_scrape
    Tag               k8s_metrics
    Host              127.0.0.1
    Port              2020
    Scrape_interval   15

[FILTER]
    Name          modify
    Match         *
    Add           cluster my-cluster

[OUTPUT]
    Name              prometheus_remote_write
    Match             *
    Host              prometheus.monitoring.svc
    Port              9090
    Uri               /api/v1/write
    # Add labels to all metrics
    add_label         cluster my-cluster
    # TLS configuration
    tls               On
    tls.verify        Off
    # Retry configuration
    Retry_Limit       3
    # Compression
    compression       snappy
