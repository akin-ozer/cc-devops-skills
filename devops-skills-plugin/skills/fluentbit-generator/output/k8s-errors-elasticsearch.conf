# Fluent Bit Configuration: Kubernetes Error Logs to Elasticsearch
# This configuration collects logs from Kubernetes pods, filters for error-level
# logs only (ERROR, FATAL, CRITICAL), applies throttling, and forwards to Elasticsearch.
#
# Generated for:
# - Cluster: prod-cluster
# - Environment: production
# - Output: Elasticsearch at elasticsearch.logging.svc:9200
# - Index prefix: k8s-errors

# ===== SERVICE SECTION =====
[SERVICE]
    # Flush interval in seconds
    Flush        1

    # Log level: off, error, warn, info, debug, trace
    Log_Level    info

    # Daemon mode (Off for containers)
    Daemon       Off

    # HTTP server for health checks and metrics
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # Enable storage metrics
    storage.metrics on

    # Parser configuration file
    Parsers_File parsers.conf

# ===== INPUT SECTION =====
[INPUT]
    Name              tail
    Tag               kube.*
    Path              /var/log/containers/*.log
    # Prevent log loops by excluding Fluent Bit's own logs
    Exclude_Path      /var/log/containers/*fluent-bit*.log
    Parser            docker
    # Position database for crash recovery
    DB                /var/log/flb_kube.db
    # Memory buffer limit per input (prevents OOM)
    Mem_Buf_Limit     50MB
    # Skip lines longer than 32KB (prevents hang)
    Skip_Long_Lines   On
    # Refresh file list every 10 seconds
    Refresh_Interval  10
    # Don't read from beginning (only new logs)
    Read_from_Head    Off

# ===== FILTER SECTION =====

# Kubernetes metadata enrichment
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    # Merge parsed JSON logs
    Merge_Log           On
    # Remove original log field after merge
    Keep_Log            Off
    # Honor pod annotations for parser
    K8S-Logging.Parser  On
    # Honor pod annotations for exclude
    K8S-Logging.Exclude On
    # Include pod labels
    Labels              On
    # Exclude annotations to reduce size
    Annotations         Off
    Buffer_Size         0

# Add cluster and environment identifiers
[FILTER]
    Name          modify
    Match         *
    Add           cluster_name prod-cluster
    Add           environment production

# Parse JSON logs to extract structured fields (including level)
[FILTER]
    Name          parser
    Match         *
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  Off

# Filter to include only error-level logs (ERROR, FATAL, CRITICAL)
# This significantly reduces log volume and storage costs
[FILTER]
    Name          grep
    Match         *
    Regex         level (ERROR|FATAL|CRITICAL|error|fatal|critical)

# Rate limiting: max 500 logs per 5 second window
# Prevents overwhelming downstream systems during log storms
[FILTER]
    Name          throttle
    Match         *
    Rate          500
    Window        5
    Interval      1m
    Print_Status  true

# Lift nested Kubernetes fields to top level with prefix
[FILTER]
    Name          nest
    Match         *
    Operation     lift
    Nested_under  kubernetes
    Add_prefix    k8s_

# ===== OUTPUT SECTION =====

# Elasticsearch output for error logs
[OUTPUT]
    Name              es
    Match             *
    Host              elasticsearch.logging.svc
    Port              9200
    # Use Logstash format for time-based indices
    Logstash_Format   On
    Logstash_Prefix   k8s-errors
    # Retry configuration
    Retry_Limit       3
    # Buffer configuration
    storage.total_limit_size 5M
    # TLS configuration
    tls               On
    tls.verify        Off  # Internal cluster with self-signed certs
    # Buffer settings
    Buffer_Size       False
    Type              _doc