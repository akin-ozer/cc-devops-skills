# Monorepo CI Pipeline Example
# Demonstrates: Path filtering, affected package detection, conditional builds, matrix for packages

name: Monorepo CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'

jobs:
  # Detect which packages have changed
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      packages: ${{ steps.filter.outputs.changes }}
      any-changed: ${{ steps.filter.outputs.any-changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0  # Need full history for path detection

      - name: Detect changed paths
        uses: dorny/paths-filter@de90cc6551a0c30ca4af50ac82dafbf57eb22fab # v3.0.2
        id: filter
        with:
          filters: |
            frontend:
              - 'packages/frontend/**'
            backend:
              - 'packages/backend/**'
            shared:
              - 'packages/shared/**'
            infrastructure:
              - 'packages/infrastructure/**'

      - name: Set any-changed flag
        id: any-changed
        run: |
          if [[ "${{ steps.filter.outputs.frontend }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.backend }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.shared }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.infrastructure }}" == "true" ]]; then
            echo "any-changed=true" >> $GITHUB_OUTPUT
          else
            echo "any-changed=false" >> $GITHUB_OUTPUT
          fi

  # Lint root configuration files
  lint-root:
    name: Lint Root Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Lint root files
        run: npm run lint:root

  # Build and test shared package (dependency for others)
  shared:
    name: Build Shared Package
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.packages contains 'shared' || needs.detect-changes.outputs.any-changed == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: packages/shared

      - name: Run linter
        run: npm run lint
        working-directory: packages/shared

      - name: Run tests
        run: npm test
        working-directory: packages/shared

      - name: Build package
        run: npm run build
        working-directory: packages/shared

      - name: Upload build artifacts
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: shared-dist
          path: packages/shared/dist/
          retention-days: 1

  # Build and test frontend package
  frontend:
    name: Build Frontend Package
    runs-on: ubuntu-latest
    needs: [detect-changes, shared]
    if: needs.detect-changes.outputs.packages contains 'frontend' || needs.detect-changes.outputs.packages contains 'shared'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download shared package
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          name: shared-dist
          path: packages/shared/dist/

      - name: Install dependencies
        run: npm ci
        working-directory: packages/frontend

      - name: Run linter
        run: npm run lint
        working-directory: packages/frontend

      - name: Run tests
        run: npm test
        working-directory: packages/frontend

      - name: Build frontend
        run: npm run build
        working-directory: packages/frontend
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: frontend-dist
          path: packages/frontend/dist/
          retention-days: 7

  # Build and test backend package
  backend:
    name: Build Backend Package
    runs-on: ubuntu-latest
    needs: [detect-changes, shared]
    if: needs.detect-changes.outputs.packages contains 'backend' || needs.detect-changes.outputs.packages contains 'shared'
    timeout-minutes: 20

    strategy:
      matrix:
        node-version: [20, 24]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Download shared package
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          name: shared-dist
          path: packages/shared/dist/

      - name: Install dependencies
        run: npm ci
        working-directory: packages/backend

      - name: Run linter
        run: npm run lint
        working-directory: packages/backend

      - name: Run unit tests
        run: npm run test:unit
        working-directory: packages/backend

      - name: Run integration tests
        run: npm run test:integration
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Build backend
        run: npm run build
        working-directory: packages/backend

      - name: Upload build artifacts
        if: matrix.node-version == 24
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: backend-dist
          path: packages/backend/dist/
          retention-days: 7

  # Validate infrastructure code
  infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.packages contains 'infrastructure'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: packages/infrastructure

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: packages/infrastructure

      - name: Terraform Validate
        run: terraform validate
        working-directory: packages/infrastructure

  # Integration test across packages
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: |
      always() &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped') &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped')
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all artifacts
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4

      - name: Install test dependencies
        run: npm ci
        working-directory: tests/integration

      - name: Run integration tests
        run: npm test
        working-directory: tests/integration

  # Summary job - gates deployment
  check-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint-root, shared, frontend, backend, infrastructure, integration]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check all job statuses
        run: |
          echo "Lint Root: ${{ needs.lint-root.result }}"
          echo "Shared: ${{ needs.shared.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Infrastructure: ${{ needs.infrastructure.result }}"
          echo "Integration: ${{ needs.integration.result }}"

          # Fail if any job failed (skipped is ok)
          if [[ "${{ needs.lint-root.result }}" == "failure" ]] || \
             [[ "${{ needs.shared.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.backend.result }}" == "failure" ]] || \
             [[ "${{ needs.infrastructure.result }}" == "failure" ]] || \
             [[ "${{ needs.integration.result }}" == "failure" ]]; then
            echo "❌ One or more jobs failed"
            exit 1
          fi

          echo "✅ All jobs passed or were skipped"

      - name: Generate summary
        run: |
          echo "## Monorepo CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ✅ All checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Lint Root: ${{ needs.lint-root.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Shared Package: ${{ needs.shared.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Package: ${{ needs.frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Package: ${{ needs.backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: ${{ needs.infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration.result }}" >> $GITHUB_STEP_SUMMARY